# Phase 2: Configuration & Dual-Theme Support

**Goal**: Implement robust configuration options and automatic Light/Dark mode support by generating dual SVGs for each diagram.

## Context
Phase 1 established the basic `.. d2::` directive. We now need to integrate user configuration (for things like global d2 config files and fonts) and solve the dark mode problem by generating two assets per diagram and toggling them on the frontend.

## Adjustment
*   **Dual Generation**: Generate separate Light and Dark SVGs for each diagram.
*   **Light**: Default theme (controlled by user config or default `0`).
*   **Dark**: Force `--theme 200` (Dark D2 theme).
*   **Frontend**: Use JS/CSS to switch visibility based on `window.matchMedia` or Sphinx theme classes.

## Plan Steps

### 1. Static Assets
Create frontend assets to handle the display logic for light/dark diagrams.

*   [ ] **Create `sphinxcontrib/d2/static/d2.js`**
    *   Implement logic to detect color scheme (prefers-color-scheme or HTML attributes).
    *   Toggle classes on parent containers or rely on CSS media queries if possible.
    *   *Note*: Simple CSS-only approaches might work if we use `picture` tag or CSS variables, but `display: none` via parent class is reliable for Sphinx themes.
*   [ ] **Create `sphinxcontrib/d2/static/d2.css`**
    *   Define styles for `.d2-figure`.
    *   Implement `.d2-light` and `.d2-dark` visibility logic.
    *   Example:
        ```css
        body.theme-dark .d2-light { display: none; }
        body.theme-light .d2-dark { display: none; }
        /* Fallback / Default logic */
        ```

### 2. Update `setup`
Register new configuration values and static assets in `sphinxcontrib/d2/__init__.py`.

*   [ ] **Add Config Values**:
    *   `d2_config`: Path to a global `.d2` config file.
    *   `d2_font`: Font family specifier.
    *   `d2_mono_font`: Monospace font family specifier.
*   [ ] **Register Assets**:
    *   `app.add_js_file('d2.js')`
    *   `app.add_css_file('d2.css')`
*   [ ] **Connect Events**:
    *   `app.connect('builder-inited', copy_static_files)`

### 3. Implement `copy_static_files`
Ensure the JS and CSS files are moved to the build's `_static` directory.

*   [ ] **Implementation**:
    *   Locate the package's `static` directory.
    *   Copy contents to `os.path.join(app.builder.outdir, '_static')` if the builder format is HTML.

### 4. Refactor `html_visit_d2`
Update the rendering logic to run D2 twice and output the composite HTML structure.

*   [ ] **Read Configuration**:
    *   If `d2_config` is set, read the content to prepend to the D2 code (or pass as CLI arg if supported, but prepending allows dynamic overrides).
*   [ ] **Run 1 (Light)**:
    *   Command: `[d2_cmd, '-', '-']` (plus font args).
    *   Output: `hash.svg`.
*   [ ] **Run 2 (Dark)**:
    *   Command: `[d2_cmd, '-', '-', '--theme', '200']` (plus font args).
    *   Output: `hash_dark.svg`.
*   [ ] **Output HTML**:
    *   Generate the container structure:
        ```html
        <div class="d2-figure" data-d2-content>
            <img class="d2-light" src="_images/hash.svg" alt="...">
            <img class="d2-dark" src="_images/hash_dark.svg" alt="...">
        </div>
        ```
