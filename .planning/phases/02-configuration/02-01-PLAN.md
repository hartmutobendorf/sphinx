# Phase 2: Configuration Implementation Plan

**Goal**: Enable users to customize D2 diagrams execution via themes, fonts, and execution paths.

## 1. Configuration Registration
*   **Target File**: `sphinxcontrib-d2/sphinxcontrib/d2/__init__.py`
*   **Action**: Update `setup` function.
*   **Details**:
    *   Add `app.add_config_value('d2_theme', 0, 'env')`. Default is 0.
    *   Add `app.add_config_value('d2_font', None, 'env')`. Default is None.
    *   Add `app.add_config_value('d2_mono_font', None, 'env')`. Default is None.

## 2. Directive Options
*   **Target File**: `sphinxcontrib-d2/sphinxcontrib/d2/__init__.py`
*   **Action**: Update `D2Directive`.
*   **Details**:
    *   Update `option_spec` to include `'theme': directives.unchanged`.
    *   In the `run` method, ensure options are correctly passed to the `d2_node`. The current implementation already does `node['options'] = self.options`.

## 3. Command Construction
*   **Target File**: `sphinxcontrib-d2/sphinxcontrib/d2/__init__.py`
*   **Action**: Refactor `html_visit_d2`.
*   **Details**:
    *   Access global configuration via `self.builder.config`:
        *   `config.d2_theme`
        *   `config.d2_font`
        *   `config.d2_mono_font`
    *   Access local node options via `node['options']`.
    *   **Theme Logic**:
        *   Check `node['options'].get('theme')`.
        *   If not present, use `config.d2_theme`.
    *   **Command Building**:
        *   Start with `[d2_cmd]`.
        *   Append `['--theme', str(theme)]` if theme is resolved (and not None).
        *   Append `['--font-regular', config.d2_font]` if `d2_font` is set.
        *   Append `['--font-mono', config.d2_mono_font]` if `d2_mono_font` is set.
        *   Append `['-', '-']` for stdin/stdout processing.
