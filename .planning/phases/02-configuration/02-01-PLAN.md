# Phase 2: Configuration - Plan

**Objective**: Implement configuration options for D2 global config file, fonts, and execution adjustments.

## Steps

1.  **Update `setup` in `__init__.py`**
    *   [ ] Verification: Ensure `d2_command` exists (CONF-01).
    *   [ ] `d2_config`: Add configuration option (default: `None`). This takes a path to a `.d2` file.
    *   [ ] `d2_font`: Add configuration option (default: `None`).
    *   [ ] `d2_mono_font`: Add configuration option (default: `None`).
    *   [ ] Cleanup: Remove `d2_theme` if previously added.

2.  **Update `D2Directive`**
    *   [ ] **CONF-03**: Ensure no local `theme` option is supported in `option_spec`. User prefers global config.

3.  **Update `html_visit_d2`**
    *   [ ] **Command Construction**:
        *   Base: `[d2_cmd, '-', '-', '--dark-theme=200']` (Always use dark theme 200 for dark mode compatibility).
        *   Fonts: Append `--font-regular` if `config.d2_font` is set.
        *   Mono Fonts: Append `--font-mono` if `config.d2_mono_font` is set.
    *   **Content Logic**:
        *   Initialize `full_code = node['code']`.
        *   If `config.d2_config` is set:
            *   Resolve path relative to `self.builder.env.app.srcdir` (or `confdir`).
            *   Register dependency: `self.builder.env.note_dependency(config_path)`.
            *   Read content of `config_path`.
            *   Prepend content: `full_code = config_content + '\n' + node['code']`.
    *   **Execution**:
        *   Execute `subprocess.run(cmd, input=full_code, ...)` and handle output.
