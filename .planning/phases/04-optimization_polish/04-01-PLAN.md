# Phase 4: Optimization & Polish

## 1. Caching (Optimization)

- [ ] Import `hashlib`.
- [ ] Implement `compute_hash(code, options, config)` helper.
- [ ] Update `render_d2`:
    - [ ] Compute hash.
    - [ ] Check for existence of output file(s).
    - [ ] Return paths if they exist (skipping generation).
    - [ ] Else proceed with generation.

## 2. Figure Support (Polish)

- [ ] Refactor `D2Directive.run`:
    - [ ] Support `caption`, `align`, `alt` options.
    - [ ] If `caption` present:
        - [ ] Create `nodes.figure(align=align)`.
        - [ ] Create `d2_node(..., alt=alt)`.
        - [ ] Create `nodes.caption(..., caption_text)`.
        - [ ] Assemble: `figure += d2_node`, `figure += caption`.
        - [ ] Return `[figure]`.
    - [ ] Else:
        - [ ] Create `d2_node(..., alt=alt, align=align)`.
        - [ ] Return `[d2_node]`.
