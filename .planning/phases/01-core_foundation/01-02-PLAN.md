<plan>
    <id>01-02</id>
    <name>Directive Implementation</name>
    <objective>Implement the `D2Directive` to parse D2 code (inline or file) and create a custom `d2_node`.</objective>
    <requirements>
        <req>CORE-01: Inline D2 code parsing</req>
        <req>CORE-02: External file support</req>
    </requirements>
    <context>
        <item>Depends on: 01-01 Foundation</item>
        <item>References: `sphinx.util.docutils.SphinxDirective`, `docutils.nodes`</item>
    </context>
    <steps>
        <step>
            <id>1</id>
            <name>Define d2_node</name>
            <description>Add `d2_node` class to `sphinxcontrib/d2/__init__.py`. It should inherit from `nodes.General`, `nodes.Inline`, `nodes.Element`.</description>
            <file>sphinxcontrib-d2/sphinxcontrib/d2/__init__.py</file>
            <edit>Add d2_node class definition (pass for now).</edit>
        </step>
        <step>
            <id>2</id>
            <name>Implement D2Directive</name>
            <description>Implement the directive class.</description>
            <file>sphinxcontrib-d2/sphinxcontrib/d2/__init__.py</file>
            <edit>
                1. Import `SphinxDirective`, `nodes`.
                2. Create `D2Directive` class.
                3. Configure `has_content = True`, `optional_arguments = 1`.
                4. Implement `option_spec` with `file`, `alt`, `caption`.
                5. Implement `run()` method:
                   - Handle `file` option (resolve path, read file, add dependency).
                   - Handle inline content.
                   - Create `d2_node` with code.
            </edit>
        </step>
        <step>
            <id>3</id>
            <name>Register Directive</name>
            <description>Register the directive and node in `setup()`.</description>
            <file>sphinxcontrib-d2/sphinxcontrib/d2/__init__.py</file>
            <edit>
                Update `setup(app)`:
                - `app.add_node(d2_node)`
                - `app.add_directive('d2', D2Directive)`
            </edit>
        </step>
    </steps>
</plan>
