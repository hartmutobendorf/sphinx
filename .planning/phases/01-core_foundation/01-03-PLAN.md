<plan>
    <id>01-03</id>
    <name>Rendering Pipeline</name>
    <objective>Implement the HTML visitor to generate SVG diagrams using the `d2` CLI.</objective>
    <requirements>
        <req>CORE-03: Invoke d2 binary</req>
        <req>CORE-04: Error handling</req>
        <req>REND-01: SVG Output</req>
    </requirements>
    <context>
        <item>Depends on: 01-02 Directive</item>
        <item>Needs `d2` CLI installed in environment for testing.</item>
    </context>
    <steps>
        <step>
            <id>1</id>
            <name>Define Error Exception</name>
            <description>Add `D2Error` class.</description>
            <file>sphinxcontrib-d2/sphinxcontrib/d2/__init__.py</file>
            <edit>Add class D2Error(SphinxError)</edit>
        </step>
        <step>
            <id>2</id>
            <name>Implement Renderer</name>
            <description>Create function `html_visit_d2`.</description>
            <file>sphinxcontrib-d2/sphinxcontrib/d2/__init__.py</file>
            <edit>
                Implement `render_d2(self, node)` (or `html_visit_d2`):
                1. Check if `d2` command exists (or configuration).
                2. Construct `d2` command args (`--theme`, etc.).
                3. Run `subprocess.run` with input from node.
                4. Catch errors and raise `D2Error` or `ExtensionError`.
                5. Process output (SVG content).
                6. Generate HTML node: `self.body.append(svg_content)`.
            </edit>
        </step>
        <step>
            <id>3</id>
            <name>Register Visitor</name>
            <description>Connect the visitor to the node.</description>
            <file>sphinxcontrib-d2/sphinxcontrib/d2/__init__.py</file>
            <edit>
                Update `app.add_node(d2_node, html=(html_visit_d2, None))`
            </edit>
        </step>
        <step>
            <id>4</id>
            <name>Add Configuration</name>
            <description>Add configuration values for d2 command, etc.</description>
            <file>sphinxcontrib-d2/sphinxcontrib/d2/__init__.py</file>
            <edit>
                In `setup()`:
                - `app.add_config_value('d2_command', 'd2', 'env')`
            </edit>
        </step>
    </steps>
</plan>
